<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Swipe Study â€“ Active / Passive (Mobile, Single-Trial)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <!-- jsPsych v6 -->
    <script src="https://unpkg.com/jspsych@6.3.1/jspsych.js"></script>
    <link href="https://unpkg.com/jspsych@6.3.1/css/jspsych.css" rel="stylesheet" />
    <script src="https://unpkg.com/jspsych@6.3.1/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="https://unpkg.com/jspsych@6.3.1/plugins/jspsych-preload.js"></script>
    <script src="https://unpkg.com/jspsych@6.3.1/plugins/jspsych-survey-likert.js"></script>
    <script src="https://unpkg.com/jspsych@6.3.1/plugins/jspsych-survey-multi-choice.js"></script>
    <script src="https://unpkg.com/jspsych@6.3.1/plugins/jspsych-survey-multi-select.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://lib.pavlovia.org/jspsych-pavlovia-2020.2.js"></script>


    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100dvh;
            background-color: #000;
            color: #fff;
            overflow-x: hidden;
            overflow-y: hidden;
            /* é˜²æ­¢é¡µé¢æ»šåŠ¨ */
            touch-action: pan-y;
            overscroll-behavior: contain;
        }

        #jspsych-target {
            width: 100vw;
            height: 100dvh;
            touch-action: pan-y;
        }

        .video-container {
            width: 100vw;
            height: 100dvh;
            position: relative;
            background-color: #000;
            overflow: hidden;
        }

        .video-container video {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            /* ç»å¯¹å±…ä¸­ */

            height: 100%;
            /* ç«–å±è§†é¢‘ï¼šé«˜åº¦é“ºæ»¡ */
            width: auto;
            /* å®½åº¦æŒ‰æ¯”ä¾‹è‡ªé€‚åº” */
            max-height: 100%;
            max-width: none;

            object-fit: cover;
            background-color: #000;
        }

        #start-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            /* ç»å¯¹å‡ ä½•ä¸­å¿ƒ */

            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            color: white;
            padding: 20px;
            box-sizing: border-box;
        }

        .center-text {
            text-align: center;
        }

        .arrow {
            font-size: 60px;
            margin-bottom: 20px;
        }

        /* ---- å¼ºåŒ– SAM å›¾ç‰‡å¤§å°ï¼Œä½¿å…¶åœ¨æ‰‹æœºç«¯æ›´æ¸…æ™° ---- */
        .sam-img {
            width: 100%;
            /* å æ»¡å¯ç”¨å®½åº¦ */
            max-width: 450px;
            /* é˜²æ­¢å¤ªå¤§ */
            height: auto;
            display: block;
            margin: 10px auto;
            /* å±…ä¸­ */
        }

        /* ===== å¼ºåŒ– jsPsych survey-likert çš„å¯è¯»æ€§ ===== */
        .jspsych-survey-likert-statement {
            font-size: 20px;
            /* é—®é¢˜æœ¬èº«æ›´å¤§ä¸€ç‚¹ */
            color: #ffffff;
            /* çº¯ç™½ */
            margin-bottom: 10px;
        }

        .jspsych-survey-likert-opts {
            margin-top: 6px;
        }

        /* æ¯ä¸ªåˆ»åº¦ä¸‹é¢çš„æ–‡å­—ï¼ˆ1-5 / 1-9ï¼‰ */
        .jspsych-survey-likert-opts li {
            font-size: 16px;
            /* åˆ»åº¦æ–‡å­—å˜å¤§ */
            color: #ffffff;
            /* çº¯ç™½ */
            opacity: 1;
            /* å»æ‰ç°æ·¡æ•ˆæœ */
        }

        /* æœ‰äº›ç‰ˆæœ¬æ–‡å­—æ”¾åœ¨ span é‡Œï¼Œå†ä¿é™©ä¸€ä¸‹ */
        .jspsych-survey-likert-opts li span,
        .jspsych-survey-likert-opts li label {
            font-size: 16px;
            color: #ffffff;
            opacity: 1;
        }

        /* æŠŠä¸¤ç«¯çš„åˆ»åº¦ï¼ˆ1 å’Œæœ€é«˜åˆ†ï¼‰åŠ ç²—ï¼Œæ›´é†’ç›® */
        .jspsych-survey-likert-opts li:first-child,
        .jspsych-survey-likert-opts li:last-child {
            font-weight: 600;
        }
    </style>
</head>

<body>

    <div id="jspsych-target"></div>

    <script>
        /************* å·¥å…·ï¼šè¯»å– URL å‚æ•° *************/
        function getUrlParam(name, def) {
            var url = new URL(window.location.href);
            return url.searchParams.get(name) || def;
        }

        var CONDITION = getUrlParam('cond', 'active');  // 'active' | 'ps' | 'pn'
        var TRACE_ID = getUrlParam('trace', '1');      // yoke trace idï¼Œç»™ ps / pn ç”¨
        var ON_PAVLOVIA = window.location.hostname.indexOf('pavlovia.org') !== -1;
        var PARTICIPANT_ID = getUrlParam('participant', jsPsych.randomization.randomID(10));

        function pavloviaErrorHandler(err) {
            // Quietly log Pavlovia errors to console; no popup to participants
            console.error('[pavlovia error]', err);
        }

        /************* é€šç”¨é‡è¡¨æ ‡ç­¾ *************/
        var LIKERT_5 = [
            "1 - Strongly disagree",
            "2",
            "3",
            "4",
            "5 - Strongly agree"
        ];

        /************* è§†é¢‘åºåˆ— *************/
        var VIDEO_SEQUENCE = Array.from(
            { length: 20 },
            (_, i) => `video${i + 1}.mp4`
        );
        var N_VIDEOS = VIDEO_SEQUENCE.length;

        // ===== Buffering / startup tuning =====
        // Only block on the first FIRST_BATCH videos; keep fetching the rest in the background.
        var FIRST_BATCH = 6;
        // Keep a look-ahead buffer of upcoming videos requested in the background.
        var AHEAD_K = 10;

        // Background prefetch (non-blocking): warms the browser's media cache using hidden <video> elements.
        var PREFETCH_CONCURRENCY = 2;   // keep small to avoid competing with the currently playing video
        var _prefetchQueue = [];
        var _prefetchActive = 0;
        var _prefetchInFlight = {};
        var _prefetchDone = {};

        function _enqueuePrefetch(url) {
            if (!url) return;
            if (_prefetchDone[url] || _prefetchInFlight[url]) return;
            _prefetchQueue.push(url);
            _prefetchInFlight[url] = true;
            _pumpPrefetch();
        }

        function _pumpPrefetch() {
            while (_prefetchActive < PREFETCH_CONCURRENCY && _prefetchQueue.length > 0) {
                var url = _prefetchQueue.shift();
                _prefetchActive++;

                (function (u) {
                    var v = document.createElement('video');
                    v.setAttribute('playsinline', '');
                    v.playsInline = true;
                    v.muted = true;
                    v.preload = 'auto';
                    v.style.position = 'fixed';
                    v.style.left = '-9999px';
                    v.style.top = '-9999px';
                    v.style.width = '1px';
                    v.style.height = '1px';

                    var settled = false;
                    function cleanup() {
                        if (settled) return;
                        settled = true;
                        try { v.pause(); } catch (e) { }
                        try { v.removeAttribute('src'); v.load(); } catch (e2) { }
                        try { document.body.removeChild(v); } catch (e3) { }
                        _prefetchDone[u] = true;
                        delete _prefetchInFlight[u];
                        _prefetchActive--;
                        _pumpPrefetch();
                    }

                    // Success as soon as we have decoded some frames / enough metadata for quick start.
                    v.addEventListener('loadeddata', cleanup, { once: true });
                    v.addEventListener('error', cleanup, { once: true });

                    // Hard timeout (don't stall the queue forever on weak networks).
                    setTimeout(cleanup, 15000);

                    try { document.body.appendChild(v); } catch (e4) { }
                    try { v.src = u; v.load(); } catch (e5) { cleanup(); }
                })(url);
            }
        }

        function ensureAheadBuffer(currentIndex) {
            for (var j = currentIndex + 1; j <= currentIndex + AHEAD_K && j < N_VIDEOS; j++) {
                _enqueuePrefetch(VIDEO_SEQUENCE[j]);
            }
        }

        /************* Yoke tracesï¼šç¤ºä¾‹ï¼Œä¹‹åè¯·ç”¨ active dwellTimes æ¥æ›¿æ¢ *************/
        var YOKED_TRACES = {
            "1": [13247, 6843, 11986, 5412, 14703, 9021, 10358, 7689, 12994, 5876, 14132, 8564, 11207, 6951, 15000, 6248, 9735, 13461, 5089, 12174]  // å•ä½ï¼šms
            // åç»­å¯ä»¥æ·»åŠ  "2": [...], "3": [...] ç­‰
        };

        var yokedDurations = null;
        if (CONDITION === 'ps' || CONDITION === 'pn') {
            yokedDurations = YOKED_TRACES[TRACE_ID];
            if (!yokedDurations || yokedDurations.length !== N_VIDEOS) {
                alert('YOKED_TRACES[' + TRACE_ID + '] æœªæ­£ç¡®è®¾ç½®æˆ–é•¿åº¦ä¸æ˜¯ ' + N_VIDEOS);
            }
        }

        // å¯é€‰å…œåº•ï¼šé˜»æ­¢æ˜æ˜¾çš„æ¨ªå‘æ»‘åŠ¨å¯¼è‡´é¡µé¢æ™ƒåŠ¨
        (function () {
            var startX = null;
            var startY = null;

            document.addEventListener('touchstart', function (e) {
                if (!e.touches || e.touches.length === 0) return;
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
            }, { passive: true });

            document.addEventListener('touchmove', function (e) {
                if (startX === null || startY === null) return;
                if (!e.touches || e.touches.length === 0) return;

                var dx = e.touches[0].clientX - startX;
                var dy = e.touches[0].clientY - startY;

                // å¦‚æœæ¨ªå‘ä½ç§»æ˜æ˜¾å¤§äºçºµå‘ï¼Œå°±è®¤ä¸ºæ˜¯â€œæ¨ªæ»‘â€ï¼Œé˜»æ­¢é¡µé¢è·Ÿç€åŠ¨
                if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 10) {
                    e.preventDefault();
                }
            }, { passive: false });
        })();

        /************* Swipe æ£€æµ‹å·¥å…·ï¼šå‘ä¸Šæ»‘ *************/
        function installSwipeUpHandler(callback, threshold) {
            threshold = threshold || 50; // è‡³å°‘ä¸Šæ»‘ 50px
            var startY = null;

            function onTouchStart(e) {
                if (!e.touches || e.touches.length === 0) return;
                startY = e.touches[0].clientY;
            }

            function onTouchEnd(e) {
                if (startY === null) return;
                var endY = (e.changedTouches && e.changedTouches[0].clientY) || startY;
                var dy = startY - endY; // å‘ä¸Šæ»‘ dy > 0
                if (dy > threshold) {
                    callback();
                }
                startY = null;
            }

            document.addEventListener('touchstart', onTouchStart);
            document.addEventListener('touchend', onTouchEnd);

            // è¿”å›æ¸…ç†å‡½æ•°
            return function removeSwipeHandler() {
                document.removeEventListener('touchstart', onTouchStart);
                document.removeEventListener('touchend', onTouchEnd);
            };
        }

        /************* åˆå§‹åŒ– timeline *************/
        var timeline = [];

        // æŠŠå‚ä¸è€…ä¿¡æ¯å†™å…¥æ•°æ®
        jsPsych.data.addProperties({
            participant: PARTICIPANT_ID,
            condition: CONDITION,
            trace_id: TRACE_ID
        });

        /************* Pavlovia åˆå§‹åŒ–ï¼ˆä»…åœ¨ pavlovia.org ç¯å¢ƒï¼‰ *************/
        var HAS_PAVLOVIA_PLUGIN = !!jsPsych.plugins['pavlovia'];
        if (ON_PAVLOVIA && HAS_PAVLOVIA_PLUGIN) {
            timeline.push({
                type: 'pavlovia',
                command: 'init',
                participantId: PARTICIPANT_ID,
                errorCallback: pavloviaErrorHandler
            });
        } else if (!HAS_PAVLOVIA_PLUGIN) {
            console.warn('Pavlovia plugin not loaded; experiment will run without online save.');
        }

        /************* é¢„åŠ è½½å‰ FIRST_BATCH æ¡è§†é¢‘ï¼ˆå¿«å¯åŠ¨ï¼‰ *************/
        var preload_trial = {
            type: 'preload',
            video: VIDEO_SEQUENCE.slice(0, Math.min(FIRST_BATCH, N_VIDEOS)),  // åªé˜»å¡å‰ 6 æ¡
            show_progress_bar: true,
            message: 'Loading first videos (fast start)â€¦',
            error_message: 'Some videos failed to load, but the study will continue.',
            continue_after_error: true,
            max_load_time: 15000   // 15 ç§’è¶…æ—¶å³æ”¾è¡Œï¼ˆå¼±ç½‘ä¸è‡³äºå¡æ­»ï¼‰
        };
        timeline.push(preload_trial);

        /************* ç¬¬ 0 é¡µï¼šç‚¹å‡»å¼€å§‹ *************/
        var unlock_trial = {
            type: 'html-keyboard-response',
            stimulus: `
      <div style="height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;color:white;padding:20px;box-sizing:border-box;">
        <p style="font-size:22px;text-align:center;margin-bottom:20px;">
          You will now watch a series of short videos.<br><br>
          Current condition:<b>${CONDITION.toUpperCase()}</b>${(CONDITION !== 'active') ? ('ï¼Œtrace=' + TRACE_ID) : ''}
        </p>
        <p style="font-size:16px;text-align:center;margin-top:10px;">
          Tap anywhere on the screen to begin.
        </p>
      </div>
    `,
            choices: jsPsych.NO_KEYS,
            on_load: function () {
                function tapHandler() {
                    document.removeEventListener('click', tapHandler);
                    jsPsych.finishTrial();
                }
                document.addEventListener('click', tapHandler);
            }
        };
        timeline.push(unlock_trial);

        /************* ACTIVEï¼šå• trial æ’­æ•´æ¡è§†é¢‘æµï¼ˆä¸Šæ»‘åˆ‡ + æ’­å®Œè‡ªåŠ¨åˆ‡ï¼‰ *************/
        var active_swipe_trial = {
            type: 'html-keyboard-response',
            stimulus: `
      <div class="video-container" id="container-main">
        <div id="start-screen">
          <div class="arrow">â†‘</div>
          <p class="center-text" style="font-size:22px;">
            Swipe up to watch the first video.
          </p>
          <p class="center-text" style="font-size:14px;opacity:0.7;margin-top:20px;">
            During the task, swipe up to move to the next video. <br>
            If you do nothing, the next video will play automatically when the current one ends.
          </p>
        </div>
        <video id="main-video"
               src=""
               playsinline
               style="display:none;"></video>
      </div>
    `,
            choices: jsPsych.NO_KEYS,
            on_load: function () {
                var container = document.getElementById('container-main');
                var startScreen = document.getElementById('start-screen');
                var video = document.getElementById('main-video');

                var currentIndex = -1;
                var currentStartTime = null;
                var dwellTimes = [];
                var endTypes = [];
                var swipeRemover = null;
                var inTransition = false;

                video.muted = false;
                video.volume = 1.0;

                function startVideo(i) {
                    if (i < 0 || i >= N_VIDEOS) return;
                    currentIndex = i;
                    ensureAheadBuffer(i);   // âœ… æ–°å¢ï¼šåå°é¢„å–åé¢ 10 æ¡
                    currentStartTime = null;      // å…ˆæ¸…ç©º
                    inTransition = false;

                    // çœŸæ­£å¼€å§‹æ’­æ”¾æ—¶å†è®°å½• time 0
                    video.onplaying = function () {
                        currentStartTime = performance.now();
                    };

                    video.src = VIDEO_SEQUENCE[i];
                    video.style.display = 'block';
                    video.currentTime = 0;

                    var p = video.play();
                    if (p && p.catch) {
                        p.catch(function (err) {
                            console.log('play() è¢«æ‹¦æˆª (active, index ' + i + '):', err);
                        });
                    }
                }

                function goToNextVideo(trigger) {
                    if (inTransition) return;
                    inTransition = true;

                    if (currentIndex === -1) {
                        // ä» start-screen è¿›å…¥ç¬¬ä¸€ä¸ªè§†é¢‘
                        startScreen.style.display = 'none';
                        startVideo(0);
                        return;
                    }

                    var now = performance.now();
                    var dwell = now - currentStartTime;
                    dwellTimes.push(dwell);
                    endTypes.push(trigger);

                    try { video.pause(); } catch (e) { }

                    if (currentIndex < N_VIDEOS - 1) {
                        startVideo(currentIndex + 1);
                    } else {
                        if (swipeRemover) swipeRemover();

                        for (var k = 0; k < dwellTimes.length; k++) {
                            jsPsych.data.write({
                                condition: 'active',
                                video_index: k,
                                video_file: VIDEO_SEQUENCE[k],
                                dwell_ms: dwellTimes[k],
                                end_type: endTypes[k]
                            });
                        }

                        jsPsych.finishTrial({
                            condition: 'active',
                            n_videos: N_VIDEOS,
                            dwell_times_ms: dwellTimes,
                            end_types: endTypes,
                            video_sequence_used: VIDEO_SEQUENCE
                        });
                    }
                }

                // ä¸Šæ»‘ -> ä¸‹ä¸€æ¡
                swipeRemover = installSwipeUpHandler(function () {
                    goToNextVideo('swipe');
                }, 50);

                // æ’­æ”¾ç»“æŸ -> è‡ªåŠ¨åˆ‡
                video.onended = function () {
                    goToNextVideo('auto');
                };
            },
            on_finish: function () {
                document.ontouchstart = null;
                document.ontouchend = null;
            }
        };

        /************* PASSIVE SWIPEï¼šTâ‚ åœæ­¢ â†’ é»‘å±æç¤ºä¸Šæ»‘ *************/
        var passive_swipe_trial = {
            type: 'html-keyboard-response',
            stimulus: `
      <div class="video-container" id="container-main">
        <div id="start-screen"
             style="width:100%;height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;">
          <div class="arrow">â†‘</div>
          <p class="center-text" style="font-size:22px;">
            Swipe up to watch the first video.
          </p>
          <p class="center-text" style="font-size:14px;opacity:0.7;margin-top:20px;">
            Please focus on the video. Each video will stop at a preset time.<br>
            When the screen turns black and the arrow appears, swipe up to continue.
          </p>
        </div>

        <!-- Main video -->
        <video id="main-video"
               src=""
               playsinline
               style="display:none;"></video>

        <!-- Black transition screen -->
        <div id="action-screen"
             style="display:none;position:absolute;top:0;left:0;width:100%;height:100%;
                    background:#000;flex-direction:column;justify-content:center;align-items:center;">
          <div class="arrow">â†‘</div>
          <p class="center-text" style="font-size:22px;">
            Swipe up to continue to the next video.
          </p>
        </div>
      </div>
    `,
            choices: jsPsych.NO_KEYS,
            on_load: function () {
                var container = document.getElementById('container-main');
                var startScreen = document.getElementById('start-screen');
                var video = document.getElementById('main-video');
                var actionScreen = document.getElementById('action-screen');

                var currentIndex = -1;
                // å†…å®¹åœç•™ï¼šplaying -> è§†é¢‘éšè—ï¼ˆè¿›å…¥é»‘å±æç¤ºï¼‰
                var contentStartTime = null;
                var contentEndTime = null;
                var realViewEndTime = null;
                var currentViewTime = null;      // æœ¬ trial çš„çœŸå® view æ—¶é•¿
                var contentDwellTimes = [];
                var dwellTimes = [];
                var viewTimes = []; // view é˜¶æ®µï¼ˆTâ‚ï¼‰çš„æ—¶é•¿
                var actionRTs = []; // ä»é»‘å±å‡ºç°åˆ° swipe çš„æ—¶é—´
                var swipeRemover = null;
                var inTransition = false;
                var phase = 'start';  // 'start' | 'view' | 'action'
                var actionStartTime = null;
                var tTimeoutId = null;     // Tâ‚ å®šæ—¶å™¨

                video.muted = false;
                video.volume = 1.0;

                function startVideo(i) {
                    if (i < 0 || i >= N_VIDEOS) return;
                    currentIndex = i;
                    ensureAheadBuffer(i);   // âœ… æ–°å¢ï¼šåå°é¢„å–åé¢ 10 æ¡
                    contentStartTime = null;      // ç”¨ onplaying è®°å½•
                    contentEndTime = null;
                    realViewEndTime = null;
                    currentViewTime = null;
                    phase = 'view';
                    inTransition = false;
                    actionStartTime = null;
                    targetDwell = yokedDurations[i];

                    // è§†é¢‘çœŸæ­£å¼€å§‹æ’­æ”¾æ—¶è®°å½•èµ·ç‚¹
                    video.onplaying = function () {
                        contentStartTime = performance.now();
                        contentEndTime = contentStartTime + targetDwell;

                        if (tTimeoutId) clearTimeout(tTimeoutId);
                        tTimeoutId = setTimeout(function () {
                            phase = 'action';

                            // ğŸ‘‰ çœŸå® view ç»“æŸæ—¶é—´ç‚¹ï¼ˆé»‘å±å‡ºç°æ—¶é—´ï¼‰
                            realViewEndTime = performance.now();
                            currentViewTime = (contentStartTime !== null)
                                ? (realViewEndTime - contentStartTime)
                                : null;

                            // actionRT çš„èµ·ç‚¹ = çœŸå® view ç»“æŸæ—¶é—´
                            actionStartTime = realViewEndTime;

                            try { video.pause(); } catch (e) { }
                            video.style.display = 'none';
                            actionScreen.style.display = 'flex';
                        }, targetDwell);
                    };

                    video.src = VIDEO_SEQUENCE[i];
                    video.style.display = 'block';
                    video.currentTime = 0;
                    actionScreen.style.display = 'none';

                    var p = video.play();
                    if (p && p.catch) {
                        p.catch(function (err) {
                            console.log('play() è¢«æ‹¦æˆª (ps, index ' + i + '):', err);
                        });
                    }
                }

                function goToNextVideoFromAction() {
                    if (inTransition) return;
                    if (phase !== 'action') return; // åªæœ‰é»‘å±é˜¶æ®µæ‰å“åº”ä¸Šæ»‘

                    inTransition = true;

                    var now = performance.now();

                    // æ€»æ—¶é•¿ï¼šä»è§†é¢‘å¼€å§‹æ’­æ”¾åˆ°è¿™æ¬¡ swipe
                    var totalDwell = (contentStartTime !== null)
                        ? (now - contentStartTime)
                        : null;

                    var contentDwell = (contentStartTime !== null && contentEndTime !== null)
                        ? (contentEndTime - contentStartTime)
                        : null;

                    // çœŸå® view æ—¶é•¿ï¼ˆä½ è¦çš„ viewTimeï¼‰
                    var viewTime = currentViewTime;  // = realViewEndTime - contentStartTime

                    // é»‘å±å‡ºç°åˆ° swipe çš„ RT
                    var actionRT = (actionStartTime !== null)
                        ? (now - actionStartTime)
                        : null;

                    contentDwellTimes.push(contentDwell);
                    viewTimes.push(viewTime);
                    dwellTimes.push(totalDwell);
                    actionRTs.push(actionRT);

                    if (tTimeoutId) {
                        clearTimeout(tTimeoutId);
                        tTimeoutId = null;
                    }

                    if (currentIndex < N_VIDEOS - 1) {
                        startVideo(currentIndex + 1);
                    } else {
                        if (swipeRemover) swipeRemover();

                        for (var k = 0; k < dwellTimes.length; k++) {
                            jsPsych.data.write({
                                condition: 'passive_swipe',
                                trace_id: TRACE_ID,
                                video_index: k,
                                video_file: VIDEO_SEQUENCE[k],
                                target_dwell_ms: yokedDurations[k],
                                content_dwell_ms: contentDwellTimes[k],
                                total_dwell_ms: dwellTimes[k],
                                view_dwell_ms: viewTimes[k],
                                rt_black_screen_ms: actionRTs[k]
                            });
                        }

                        jsPsych.finishTrial({
                            condition: 'passive_swipe',
                            trace_id: TRACE_ID,
                            n_videos: N_VIDEOS,
                            content_dwell_times_ms: contentDwellTimes,
                            dwell_times_ms: dwellTimes,
                            view_times_ms: viewTimes,
                            rt_black_screen_ms: actionRTs,
                            video_sequence_used: VIDEO_SEQUENCE
                        });
                    }
                }

                // ä¸Šæ»‘ï¼šstart-screen -> ç¬¬ä¸€ä¸ªè§†é¢‘ï¼›é»‘å±ä¸‹ -> è¿›å…¥ä¸‹ä¸€æ¡
                swipeRemover = installSwipeUpHandler(function () {
                    if (currentIndex === -1) {
                        // ä» start-screen è¿›å…¥ç¬¬ä¸€ä¸ªè§†é¢‘
                        startScreen.style.display = 'none';
                        startVideo(0);
                    } else {
                        // åªæœ‰å¤„äº action é˜¶æ®µï¼ˆé»‘å±æç¤ºï¼‰æ—¶æ‰å“åº”
                        if (phase === 'action') {
                            goToNextVideoFromAction();
                        }
                    }
                }, 50);

                // åœ¨ ps æ¡ä»¶ä¸‹ï¼Œä¸åœ¨ onended åšä»»ä½•äº‹ï¼ˆé€»è¾‘ç”± Tâ‚ å®šæ—¶å™¨æ§åˆ¶ï¼‰
                video.onended = function () {
                    // å¯ä»¥ç•™ç©ºï¼Œæˆ–è€… log ä¸€ä¸‹
                    console.log('Video ended before Tâ‚ in ps, index:', currentIndex);
                };
            },
            on_finish: function () {
                document.ontouchstart = null;
                document.ontouchend = null;
            }
        };

        /************* PASSIVE NON-SWIPEï¼šä¸¥æ ¼è¢«åŠ¨ï¼ŒæŒ‰ Tâ‚ è‡ªåŠ¨åˆ‡æ¢ï¼Œä¸å“åº”ä¸Šæ»‘ *************/
        var passive_non_swipe_trial = {
            type: 'html-keyboard-response',
            stimulus: `
      <div class="video-container" id="container-main">
        <div id="start-screen"
     style="width:100%;height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;">
  <div class="arrow">â†‘</div>
  <p class="center-text" style="font-size:22px;">
    Swipe up to watch the first video.
  </p>
  <p class="center-text" style="font-size:14px;opacity:0.7;margin-top:20px;">
    After the first swipe, the videos will advance automatically.<br>
    Please do not swipe or tap during playback.
  </p>
</div>
        <video id="main-video"
               src=""
               playsinline
               style="display:none;"></video>
      </div>
    `,
            choices: jsPsych.NO_KEYS,
            on_load: function () {
                var container = document.getElementById('container-main');
                var startScreen = document.getElementById('start-screen');
                var video = document.getElementById('main-video');

                var currentIndex = -1;
                // å†…å®¹åœç•™ï¼šplaying -> è§†é¢‘è¢«éšè—/æš‚åœ
                var contentStartTime = null;
                var contentEndTime = null;
                var contentDwellTimes = [];
                var dwellTimes = [];
                var tTimeoutId = null;
                var currentTargetDwell = null;

                video.muted = false;
                video.volume = 1.0;

                function startVideo(i) {
                    if (i < 0 || i >= N_VIDEOS) return;
                    currentIndex = i;
                    ensureAheadBuffer(i);   // âœ… æ–°å¢ï¼šåå°é¢„å–åé¢ 10 æ¡
                    contentStartTime = null;   // ç­‰ onplaying
                    contentEndTime = null;
                    currentTargetDwell = yokedDurations[i];

                    // çœŸæ­£å¼€å§‹æ’­æ”¾æ—¶è®°å½•
                    video.onplaying = function () {
                        contentStartTime = performance.now();

                        if (tTimeoutId) clearTimeout(tTimeoutId);
                        tTimeoutId = setTimeout(function () {
                            // ç»“æŸæ—¶é—´æŒ‰ contentStartTime + é¢„è®¾ dwellï¼ˆé¿å…è®¡å…¥å®šæ—¶å™¨æŠ–åŠ¨ï¼‰
                            contentEndTime = (contentStartTime !== null)
                                ? (contentStartTime + currentTargetDwell)
                                : performance.now();
                            goToNextVideoAuto();
                        }, currentTargetDwell);
                    };

                    video.src = VIDEO_SEQUENCE[i];
                    video.style.display = 'block';
                    video.currentTime = 0;

                    var p = video.play();
                    if (p && p.catch) {
                        p.catch(function (err) {
                            console.log('play() è¢«æ‹¦æˆª (pn, index ' + i + '):', err);
                        });
                    }
                }


                function goToNextVideoAuto() {
                    var now = performance.now();
                    var contentDwell = (contentStartTime !== null && contentEndTime !== null)
                        ? (contentEndTime - contentStartTime)
                        : null;
                    // å…ˆæŒ‰å®é™…æµ‹å¾—çš„ now - startï¼Œå†è°ƒæ•´åˆ° target_dwellï¼ˆpn è¦æ±‚ä¸¥æ ¼ç­‰äº targetï¼‰
                    var measuredDwell = (contentStartTime !== null) ? (now - contentStartTime) : currentTargetDwell;
                    dwellTimes.push(measuredDwell);
                    contentDwellTimes.push(contentDwell);

                    try { video.pause(); } catch (e) { }

                    if (currentIndex < N_VIDEOS - 1) {
                        startVideo(currentIndex + 1);
                    } else {
                        if (tTimeoutId) {
                            clearTimeout(tTimeoutId);
                            tTimeoutId = null;
                        }

                        for (var k = 0; k < dwellTimes.length; k++) {
                            jsPsych.data.write({
                                condition: 'passive_non_swipe',
                                trace_id: TRACE_ID,
                                video_index: k,
                                video_file: VIDEO_SEQUENCE[k],
                                target_dwell_ms: yokedDurations[k],
                                content_dwell_ms: contentDwellTimes[k],
                                dwell_ms: dwellTimes[k]
                            });
                        }

                        jsPsych.finishTrial({
                            condition: 'passive_non_swipe',
                            trace_id: TRACE_ID,
                            n_videos: N_VIDEOS,
                            content_dwell_times_ms: contentDwellTimes,
                            dwell_times_ms: dwellTimes,
                            video_sequence_used: VIDEO_SEQUENCE
                        });
                    }
                }

                // ä¸å®‰è£… swipe handlerï¼Œå®Œå…¨å¿½ç•¥ä¸Šæ»‘
                // åªåœ¨ start-screen åè‡ªåŠ¨å¼€å§‹
                //setTimeout(function () {
                //startScreen.style.display = 'none';
                //startVideo(0);
                //}, 1000); // 1 ç§’åå¼€å§‹ï¼Œä¹Ÿå¯ä»¥æ”¹æˆç‚¹å‡»è§¦å‘

                // âœ… PNï¼šå¿…é¡» swipe up ä¸€æ¬¡æ‰å¼€å§‹æ’­æ”¾ç¬¬ä¸€ä¸ªè§†é¢‘
                var swipeRemover = installSwipeUpHandler(function () {
                    if (currentIndex === -1) {
                        startScreen.style.display = 'none';
                        startVideo(0);

                        // åªéœ€è¦ç¬¬ä¸€æ¬¡ swipe ç”¨æ¥â€œå¼€å§‹â€ï¼Œä¹‹åç«‹åˆ»ç§»é™¤ç›‘å¬ï¼Œä¿è¯ PN ä»æ˜¯â€œnon-swipeâ€
                        if (swipeRemover) swipeRemover();
                    }
                }, 50);

                video.onended = function () {
                    // ç†è®ºä¸Šä¸ä¼šä¾èµ– onendedï¼Œè€Œæ˜¯ç”¨ Tâ‚ï¼›è¿™é‡Œå¯ä»¥ä»…åšæ—¥å¿—
                    console.log('Video ended before Tâ‚ in pn, index:', currentIndex);
                };
            },
            on_finish: function () {
                document.ontouchstart = null;
                document.ontouchend = null;
            }
        };

        /************* Measures 1ï¼šPost-viewing self-report & checks *************/

        // 1) å…ˆå»ºä¸€ä¸ªâ€œåŸºç¡€é¢˜ç›®â€æ•°ç»„ï¼ˆä¸å« habit é¢˜ï¼‰
        var post_view_questions = [
            {
                prompt: "I felt that I was in control of when the next video appeared.",
                name: "agency_control",
                labels: LIKERT_5,
                required: true
            },
            {
                prompt: "It felt like the system decided when to move to the next video, not me.",
                name: "agency_system",
                labels: LIKERT_5,
                required: true
            },
            {
                prompt: "If the task had not ended, I would probably have kept going for quite a while.",
                name: "continue_watching",
                labels: LIKERT_5,
                required: true
            },
            {
                prompt: "I found the videos interesting to watch.",
                name: "interest",
                labels: LIKERT_5,
                required: true
            },
            {
                prompt: "I found the videos boring.",
                name: "boredom",
                labels: LIKERT_5,
                required: true
            },
            {
                prompt: `
            <div style="text-align:left;">
              <p>Please indicate how you felt overall while watching the videos.</p>
              <img src="sam_valence.png" class="sam-img">
            </div>
          `,
                name: "sam_valence",
                labels: ["1", "2", "3", "4", "5"],
                required: true
            },
            {
                prompt: `
            <div style="text-align:left;">
              <p>Please indicate how you felt overall while watching the videos.</p>
              <img src="sam_arousal.png" class="sam-img">
            </div>
          `,
                name: "sam_arousal",
                labels: ["1", "2", "3", "4", "5"],
                required: true
            },
            {
                prompt: `
            <div style="text-align:left;">
              <p>Please indicate how you felt overall while watching the videos.</p>
              <img src="sam_control.png" class="sam-img">
            </div>
          `,
                name: "sam_control",
                labels: ["1", "2", "3", "4", "5"],
                required: true
            },
            {
                // attention checkï¼šç”¨ 1â€“5
                prompt: "To show that you are paying attention, please select â€˜4â€™ for this item.",
                name: "attention_check_1to5",
                labels: [
                    "1",
                    "2",
                    "3",
                    "4",
                    "5"
                ],
                required: true
            }
        ];

        // 2) åªæœ‰ active æ—¶æ’å…¥ habit é¢˜ï¼Œä½ç½®æ”¾åœ¨ SAM ä¸‰é¢˜çš„å‰é¢
        if (CONDITION === 'active') {

            // æ‰¾åˆ° SAM valence çš„ index
            var sam_index = post_view_questions.findIndex(q => q.name === "sam_valence");

            // æ’å…¥ habit é¢˜åœ¨ SAM ä¹‹å‰
            post_view_questions.splice(sam_index, 0, {
                prompt: "I felt I was continuing out of habit rather than deliberate choice.",
                name: "habit_vs_deliberate",
                labels: LIKERT_5,
                required: true
            });
        }


        // 3) ç”¨è¿™ä¸ªæ•°ç»„ç”Ÿæˆ survey-likert trial
        var post_view_likert_trial = {
            type: 'survey-likert',
            preamble: `
    <div style="padding:10px 5px 0 5px;">
      <p style="font-size:18px; text-align:left;">
        You have finished watching the video feed.<br><br>
        Please answer the following questions about your experience.
      </p>
    </div>
  `,
            questions: post_view_questions,
            randomize_question_order: false
        };

        /************* Measures 2ï¼šRecognition memoryï¼ˆç¤ºä¾‹ï¼šä¸€é¡µ 4 å¼ å›¾ï¼‰ *************/
        var RECOG_ITEMS = [
            { id: "rec1", file: "rec_real_01.png", status: "real" },
            { id: "rec2", file: "rec_real_02.png", status: "real" },
            { id: "rec3", file: "rec_real_03.png", status: "real" },
            { id: "rec4", file: "rec_real_04.png", status: "real" }
        ];

        // æ„å»º HTMLï¼š4 å¼ å›¾ + checkbox
        function buildRecognitionHTML() {
            var html = `
        <div style="width:100vw;height:100vh;display:flex;flex-direction:column;justify-content:flex-start;align-items:center;color:white;padding:10px;box-sizing:border-box;">
          <p style="font-size:18px;text-align:left;width:100%;max-width:500px;margin-bottom:10px;">
            On this page you will see four still images taken from short videos.<br>
            Please tick the videos that you remember seeing in the feed.
          </p>
        <div style="display:flex;flex-wrap:wrap;justify-content:center;gap:10px;width:100%;max-width:500px;">
      `;

            RECOG_ITEMS.forEach(function (item) {
                html += `
        <div style="width:48%;display:flex;flex-direction:column;align-items:center;margin-bottom:10px;">
          <img src="${item.file}" style="width:100%;height:auto;border:1px solid #666;margin-bottom:5px;" />
          <label style="font-size:14px;">
            <input type="checkbox" id="${item.id}" style="margin-right:5px;">
            I saw this video
          </label>
        </div>
      `;
            });

            html += `
      </div>
        <button id="rec-next-btn"
            style="margin-top:15px;padding:10px 20px;font-size:16px;border-radius:8px;border:none;background:#444;color:#fff;">
          Continue
        </button>
      </div>
    `;
            return html;
        }

        var recognition_trial = {
            type: 'html-keyboard-response',
            stimulus: buildRecognitionHTML,
            choices: jsPsych.NO_KEYS,
            on_load: function () {
                var btn = document.getElementById('rec-next-btn');
                btn.addEventListener('click', function () {
                    // è¯»å–æ¯ä¸ª checkbox æ˜¯å¦å‹¾é€‰
                    var selections = {};
                    RECOG_ITEMS.forEach(function (item) {
                        var checked = document.getElementById(item.id).checked;
                        selections[item.id] = {
                            checked: checked,
                            file: item.file,
                            status: item.status
                        };
                    });
                    jsPsych.finishTrial({
                        recognition_responses: selections
                    });
                });
            }
        };

        /************* Measures 3ï¼šDelay Discountingï¼ˆç®€ç‰ˆç¤ºä¾‹ï¼‰ *************/

        // TODO: åœ¨æ­£å¼ç‰ˆæœ¬ä¸­ï¼ŒæŠŠ items æ‰©å±•åˆ° 27 ä¸ªï¼Œå¹¶ç”¨ Kirby çš„æ ‡å‡†é‡‘é¢å’Œå»¶è¿Ÿ
        var DD_ITEMS = [
            {
                name: "dd1",
                prompt: "1. Would you prefer Â£54 today or Â£55 in 117 days?",
                options: ["Â£54 today", "Â£55 in 117 days"]
            },
            {
                name: "dd2",
                prompt: "2. Would you prefer Â£55 today or Â£75 in 61 days?",
                options: ["Â£55 today", "Â£75 in 61 days"]
            },
            {
                name: "dd3",
                prompt: "3. Would you prefer Â£19 today, or Â£25 in 53 days?",
                options: ["Â£19 today", "Â£25 in 53 days"]
            },
            {
                name: "dd4",
                prompt: "4. Would you prefer Â£31 today, or Â£85 in 7 days?",
                options: ["Â£31 today", "Â£85 in 7 days?"]
            },
            {
                name: "dd5",
                prompt: "5. Would you prefer Â£14 today, or Â£25 in 19 days?",
                options: ["Â£14 today", "Â£25 in 19 days"]
            },
            {
                name: "dd6",
                prompt: "6. Would you prefer Â£47 today, or Â£50 in 160 days?",
                options: ["Â£47 today", "Â£50 in 160 days"]
            },
            {
                name: "dd7",
                prompt: "7. Would you prefer Â£15 today, or Â£35 in 13 days?",
                options: ["Â£15 today", "Â£35 in 1 month"]
            },
            {
                name: "dd8",
                prompt: "8. Would you prefer Â£25 today, or Â£60 in 14 days?",
                options: ["Â£25 today", "Â£60 in 4 months"]
            },
            {
                name: "dd9",
                prompt: "9. Would you prefer Â£78 today, or Â£80 in 162 days?",
                options: ["Â£78 today", "Â£80 in 162 days"]
            },
            {
                name: "dd10",
                prompt: "10. Would you prefer Â£40 today, or Â£55 in 62 days?",
                options: ["Â£40 today", "Â£55 in 62 days"]
            },
            {
                name: "dd11",
                prompt: "11. Would you prefer Â£11 today, or Â£30 in 7 days?",
                options: ["Â£11 today", "Â£30 in 7 days"]
            },
            {
                name: "dd12",
                prompt: "12. Would you prefer Â£67 today, or Â£75 in 119 days?",
                options: ["Â£67 today", "Â£75 in 119 days"]
            },
            {
                name: "dd13",
                prompt: "13. Would you prefer Â£34 today, or Â£35 in 186 days?",
                options: ["Â£34 today", "Â£35 in 186 days"]
            },
            {
                name: "dd14",
                prompt: "14. Would you prefer Â£27 today, or Â£50 in 21 days?",
                options: ["Â£27 today", "Â£50 in 21 days"]
            },
            {
                name: "dd15",
                prompt: "15. Would you prefer Â£69 today, or Â£85 in 91 days?",
                options: ["Â£69 today", "Â£85 in 91 days"]
            },
            {
                name: "dd16",
                prompt: "16. Would you prefer Â£49 today, or Â£60 in 89 days?",
                options: ["Â£49 today", "Â£60 in 89 days"]
            },
            {
                name: "dd17",
                prompt: "17. Would you prefer Â£80 today, or Â£85 in 157 days?",
                options: ["Â£80 today", "Â£85 in 157 days"]
            },
            {
                name: "dd18",
                prompt: "18. Would you prefer Â£24 today, or Â£35 in 29 days?",
                options: ["Â£24 today", "Â£35 in 29 days"]
            },
            {
                name: "dd19",
                prompt: "19. Would you prefer Â£33 today, or Â£80 in 14 days?",
                options: ["Â£33 today", "Â£80 in 14 days"]
            },
            {
                name: "dd20",
                prompt: "20. Would you prefer Â£28 today, or Â£30 in 179 days?",
                options: ["Â£28 today", "Â£30 in 179 days"]
            },
            {
                name: "dd21",
                prompt: "21. Would you prefer Â£34 today, or Â£50 in 30 days?",
                options: ["Â£34 today", "Â£50 in 30 days"]
            },
            {
                name: "dd22",
                prompt: "22. Would you prefer Â£25 today, or Â£30 in 80 days?",
                options: ["Â£25 today", "Â£30 in 80 days"]
            },
            {
                name: "dd23",
                prompt: "23. Would you prefer Â£41 today, or Â£75 in 20 days?",
                options: ["Â£41 today", "Â£75 in 20 days"]
            },
            {
                name: "dd24",
                prompt: "24. Would you prefer Â£54 today, or Â£60 in 111 days?",
                options: ["Â£54 today", "Â£60 in 111 days"]
            },
            {
                name: "dd25",
                prompt: "25. Would you prefer Â£54 today, or Â£80 in 30 days?",
                options: ["Â£54 today", "Â£80 in 30 days"]
            },
            {
                name: "dd26",
                prompt: "26. Would you prefer Â£22 today, or Â£25 in 136 days?",
                options: ["Â£22 today", "Â£25 in 136 days"]
            },
            {
                name: "dd27",
                prompt: "27. Would you prefer Â£20 today, or Â£55 in 7 days?",
                options: ["Â£20 today", "Â£55 in 7 days"]
            }
        ];

        var delay_discount_trial = {
            type: 'survey-multi-choice',
            preamble: `
        <div style="padding:10px 5px 0 5px;">
          <p style="font-size:18px;text-align:left;">
            In this final part, you will make 27 choices.<br>
            For each of the choices, please indicate which reward you would prefer:<br>
            the smaller reward today, or the larger reward in the specified number of days.<br><br>
            Please answer as if these choices were real.
          </p>
        </div>
      `,
            questions: DD_ITEMS.map(function (item) {
                return {
                    prompt: item.prompt,
                    name: item.name,
                    options: item.options,
                    required: true
                };
            }),
            randomize_question_order: false,
            on_load: function () {
                // ç¡®ä¿è¿›å…¥è¯¥é¡µæ—¶è§†å£å›åˆ°é¡¶éƒ¨ï¼Œé¿å…ä»ä¸­é—´å¼€å§‹æ˜¾ç¤º
                var scrollTop = function () {
                    window.scrollTo(0, 0);
                    document.body.scrollTop = 0;
                    document.documentElement.scrollTop = 0;
                    var wrap = document.querySelector('.jspsych-content-wrapper');
                    if (wrap) wrap.scrollTop = 0;
                    var display = document.querySelector('.jspsych-display-element');
                    if (display) display.scrollTop = 0;
                };
                requestAnimationFrame(function () {
                    scrollTop();
                    setTimeout(scrollTop, 50); // å†æ¬¡æ‹‰å›é¡¶éƒ¨ï¼Œç¡®ä¿æ¸²æŸ“å®Œæˆåä¹Ÿåœ¨é¡¶éƒ¨
                });
            }
        };


        /************* æ ¹æ® CONDITION é€‰æ‹©å¯¹åº”çš„ trial *************/
        if (CONDITION === 'active') {
            timeline.push(active_swipe_trial);
        } else if (CONDITION === 'ps') {
            timeline.push(passive_swipe_trial);
        } else if (CONDITION === 'pn') {
            timeline.push(passive_non_swipe_trial);
        } else {
            alert('æœªçŸ¥æ¡ä»¶ cond=' + CONDITION);
        }

        /************* åœ¨ viewing ä¹‹åè¿½åŠ  Measures *************/
        timeline.push(post_view_likert_trial);
        timeline.push(recognition_trial);
        timeline.push(delay_discount_trial);

        /************* ç»“æŸé¡µ *************/
        var end_trial = {
            type: 'html-keyboard-response',
            stimulus: `
    <div class="video-container">
      <div style="width:100%;height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;">
        <p class="center-text" style="font-size:24px;">
          All tasks have been completed.<br><br>
          Thank you for your participation!
        </p>
        <p class="center-text" style="font-size:14px;opacity:0.8;margin-top:10px;">
          ${ON_PAVLOVIA ? 'Uploading to Pavloviaâ€¦<br>Please keep this page open.' : 'You may now close this page.'}
        </p>
      </div>
    </div>
  `,
            choices: jsPsych.NO_KEYS,
            trial_duration: 1500
        };
        timeline.push(end_trial);

        /************* Pavlovia ç»“æŸå¹¶ä¸Šä¼ æ•°æ®ï¼ˆä»…åœ¨ pavlovia.orgï¼‰ *************/
        if (ON_PAVLOVIA && HAS_PAVLOVIA_PLUGIN) {
            timeline.push({
                type: 'pavlovia',
                command: 'finish',
                participantId: PARTICIPANT_ID,
                sync: true, // use Beacon API if available
                errorCallback: pavloviaErrorHandler
            });
            timeline.push({
                type: 'html-keyboard-response',
                stimulus: `
    <div class="video-container">
      <div style="width:100%;height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;">
        <p class="center-text" style="font-size:22px;">
          Upload complete. You may now close this page.
        </p>
      </div>
    </div>
  `,
                choices: jsPsych.NO_KEYS,
                trial_duration: 1500
            });
        }


        /************* å¯åŠ¨ jsPsych *************/
        jsPsych.init({
            display_element: 'jspsych-target',
            timeline: timeline
        });
    </script>

</body>

</html>
