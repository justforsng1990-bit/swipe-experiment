<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Swipe Study – 5 Videos, Keyboard, 3 Conditions (jsPsych 6)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- jsPsych v6 -->
  <script src="https://unpkg.com/jspsych@6.3.1/jspsych.js"></script>
  <link href="https://unpkg.com/jspsych@6.3.1/css/jspsych.css" rel="stylesheet" />
  <script src="https://unpkg.com/jspsych@6.3.1/plugins/jspsych-html-keyboard-response.js"></script>
  <script src="https://unpkg.com/jspsych@6.3.1/plugins/jspsych-preload.js"></script>
  <script src="https://unpkg.com/jspsych@6.3.1/plugins/jspsych-survey-likert.js"></script>
  <script src="https://unpkg.com/jspsych@6.3.1/plugins/jspsych-survey-multi-choice.js"></script>
  <script src="https://unpkg.com/jspsych@6.3.1/plugins/jspsych-survey-multi-select.js"></script>


  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #000;
      color: #fff;
    }

    .video-container {
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #000;
      flex-direction: column;
    }

    video {
      max-width: 100%;
      max-height: 80%;
      pointer-events: none;
    }

    /* ===== 强化 jsPsych survey-likert 的可读性 ===== */
    .jspsych-survey-likert-statement {
      font-size: 20px;
      /* 问题本身更大一点 */
      color: #ffffff;
      /* 纯白 */
      margin-bottom: 10px;
    }

    .jspsych-survey-likert-opts {
      margin-top: 6px;
    }

    /* 每个刻度下面的文字（1-5 / 1-9） */
    .jspsych-survey-likert-opts li {
      font-size: 16px;
      /* 刻度文字变大 */
      color: #ffffff;
      /* 纯白 */
      opacity: 1;
      /* 去掉灰淡效果 */
    }

    /* 有些版本文字放在 span 里，再保险一下 */
    .jspsych-survey-likert-opts li span,
    .jspsych-survey-likert-opts li label {
      font-size: 16px;
      color: #ffffff;
      opacity: 1;
    }

    /* 把两端的刻度（1 和最高分）加粗，更醒目 */
    .jspsych-survey-likert-opts li:first-child,
    .jspsych-survey-likert-opts li:last-child {
      font-weight: 600;
    }
  </style>
</head>

<body>

  <div id="jspsych-target"></div>

  <script>
    /************* 工具：读取 URL 参数 *************/
    function getUrlParam(name, def) {
      var url = new URL(window.location.href);
      return url.searchParams.get(name) || def;
    }

    // 条件: active / ps / pn
    var CONDITION = getUrlParam('cond', 'active');   // 'active' | 'ps' | 'pn'
    var TRACE_ID = getUrlParam('trace', '1');       // yoke trace id

    /************* 通用量表标签 *************/
    var LIKERT_5 = [
      "1 - Strongly disagree",
      "2",
      "3",
      "4",
      "5 - Strongly agree"
    ];

    /************* 视频序列 & yoke traces *************/
    var VIDEO_SEQUENCE = [
      'video1.mp4',
      'video2.mp4',
      'video3.mp4',
      'video4.mp4',
      'video5.mp4'
    ];
    var N_VIDEOS = VIDEO_SEQUENCE.length;

    // 示例 yoke：5 个视频的目标停留时间（毫秒）
    var YOKED_TRACES = {
      "1": [3000, 4500, 4000, 3500, 5000]
      // 之后你可以加 "2": [...], "3": [...] 等
    };

    var yokedDurations = null;
    if (CONDITION === 'ps' || CONDITION === 'pn') {
      yokedDurations = YOKED_TRACES[TRACE_ID];
      if (!yokedDurations || yokedDurations.length !== N_VIDEOS) {
        alert('YOKED_TRACES[' + TRACE_ID + '] 未正确设置或长度不是 ' + N_VIDEOS);
      }
    }

    /************* 初始化 timeline *************/
    var timeline = [];

    /************* 新增：预加载所有视频（带进度条） *************/
    var preload_trial = {
      type: 'preload',
      video: VIDEO_SEQUENCE,               // 这里将来换成你60条视频的数组
      show_progress_bar: true,
      message: 'Loading videos. Please wait…',
      error_message: 'Some videos failed to load, but the study will continue.',
      continue_after_error: true,          // 万一某条加载失败，不整个卡死
      max_load_time: 60000                // 最长等 60 秒（1 分钟），可按需要调整
    };
    timeline.push(preload_trial);

    /************* 第 0 页：按 Enter 解锁声音 + 说明键位 *************/
    var unlock_trial = {
      type: 'html-keyboard-response',
      stimulus: `
      <div style="height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;color:white;">
        <p style="font-size:22px;text-align:center;">
          You will now watch a series of short videos.<br><br>
          To allow the videos to play automatically with sound,<br>
          please press the <b>Enter</b> key to start.
        </p>
        <p style="font-size:16px;margin-top:20px;">
          Throughout the task:<br>
          &bull; In the <b>ACTIVE</b> or <b>PASSIVE SWIPE</b> condition, press the <b>Space</b> bar to go to the next video.<br>
          &bull; In the <b>PASSIVE NON-SWIPE</b> condition, the videos will advance automatically.
        </p>
        <p style="font-size:14px;margin-top:10px;">
          Current condition：${CONDITION.toUpperCase()}${(CONDITION !== 'active') ? ('，trace=' + TRACE_ID) : ''}
        </p>
      </div>
    `,
      choices: jsPsych.NO_KEYS,
      on_load: function () {
        function handler(e) {
          if (e.code === 'Enter' || e.keyCode === 13) {
            e.preventDefault();
            document.removeEventListener('keydown', handler);
            setTimeout(function () {
              jsPsych.finishTrial();
            }, 0);
          }
        }
        document.addEventListener('keydown', handler);
      }
    };
    timeline.push(unlock_trial);

    /************* 工具：添加 Space 监听（当前 trial 用一次） *************/
    function addSpaceListener(finishCallback) {
      function handler(e) {
        if (e.code === 'Space' || e.keyCode === 32) {
          e.preventDefault();
          document.removeEventListener('keyup', handler);
          setTimeout(function () {
            finishCallback();
          }, 0);
        }
      }
      document.addEventListener('keyup', handler);
    }

    /************* ACTIVE 条件：自由按 Space 切换 *************/
function makeActiveVideoTrial(index, videoFile) {
  return {
    type: 'html-keyboard-response',
    stimulus: `
      <div class="video-container">
        <video id="video-${index}" src="${videoFile}" playsinline></video>
      </div>
    `,
    choices: jsPsych.NO_KEYS,
    on_load: function () {
      var v = document.getElementById('video-' + index);
      v.muted = false;
      v.volume = 1.0;

      let realStart = null;

      // 关键：视频真正开始播放的时间点
      v.onplaying = function () {
        realStart = performance.now();
      };

      // 播放视频
      var p = v.play();
      if (p !== undefined) {
        p.catch(function (err) {
          console.log(videoFile + ' play() 被拦截：', err);
        });
      }

      // 按 Space 结束 trial，并用 realStart 计算 dwell
      addSpaceListener(function () {
        // 保险：如果 realStart 还没被写入（极端情况下），直接忽略这次按键
        if (realStart === null) {
          console.warn('Space pressed before video started playing; ignoring.');
          return;
        }

        var dwell = performance.now() - realStart;

        jsPsych.finishTrial({
          condition: 'active',
          video_index: index,
          video_file: videoFile,
          ended_by: 'space',
          dwell_ms: dwell
        });
      });
    }
  };
}

    /************* PASSIVE SWIPE 条件（视图/动作分离版） 
     删除了下面在屏幕上的显示 183-184之间 <p style="text-align:center;margin-bottom:10px;">
              条件：PASSIVE SWIPE（被动时间 + 主动按键）<br>
              当前视频：${videoFile}<br>
              请专注观看视频。视频会在适当时间自动停止，<br>
              屏幕变成黑色并出现向上箭头，这时请尽快按空格键（Space）继续。
            </p>
    *************/
    function makePassiveSwipeVideoTrial(index, videoFile, yokedDurations) {
      var targetDwell = yokedDurations[index]; // ms，预定观看时间 T_a

      return {
        type: 'html-keyboard-response',
        stimulus: `
        <div class="video-container">
          <video id="video-${index}" src="${videoFile}" playsinline></video>
          <div id="action-screen-${index}"
     style="
       display:none;
       width:100%;
       height:60%;
       flex-direction:column;
       justify-content:center;
       align-items:center;
       text-align:center;
     ">
     
     <!-- Down arrow -->
     <div style="font-size:80px; margin-bottom:25px;">
        &#x2193;   <!-- Unicode 向下箭头 ↓ -->
     </div>

     <!-- SPACE key visual -->
     <div style="
        font-size:24px;
        padding:15px 60px;
        border:2px solid #fff;
        border-radius:10px;
        background-color:#111;
        box-shadow:0px 0px 10px rgba(255,255,255,0.3);
        margin-bottom:20px;
     ">
        SPACE
     </div>

     <p style="font-size:20px; opacity:0.8;">
        Press the Space bar to go to the next video.
     </p>
</div>
        </div>
      `,
        choices: jsPsych.NO_KEYS,
        on_load: function () {
          var v = document.getElementById('video-' + index);
          var actionScreen = document.getElementById('action-screen-' + index);

          v.muted = false;
          v.volume = 1.0;

          let realStart = null;
          let viewEndTime = null;

          // 视频真正开始播放的时间点
          v.onplaying = function () {
            realStart = performance.now();
          };

          var p = v.play();
          if (p !== undefined) {
            p.catch(function (err) {
              console.log(videoFile + ' play() 被拦截：', err);
            });
          }

          // 在 yoke 时间点停止视频
          viewTimeout = setTimeout(function () {
            viewEnded = true;
            viewEndTime = performance.now();

            try { v.pause(); } catch (e) { console.log('pause error:', e); }
            v.style.display = 'none';

            actionScreen.style.display = 'flex';
          }, targetDwell);

          // Space —— 只在黑屏出现之后响应
          function spaceHandler(e) {
            if (e.code !== 'Space' && e.keyCode !== 32) return;

            if (!viewEnded) return;           // 黑屏前全部忽略
            document.removeEventListener('keyup', spaceHandler);

            const now = performance.now();
            const viewDwell = viewEndTime - realStart; // 观看阶段时长
            const actionRT = now - viewEndTime;        // 黑屏反应时
            const total = now - realStart;

            jsPsych.finishTrial({
              condition: 'passive_swipe',
              trace_id: TRACE_ID,
              video_index: index,
              video_file: videoFile,
              target_dwell_ms: targetDwell,
              view_dwell_ms: viewDwell,
              action_rt_ms: actionRT,
              total_trial_ms: total,
              ended_by: 'space'
            });
          }
          document.addEventListener('keyup', spaceHandler);
        }
      };
    }

    /************* PASSIVE NON-SWIPE 条件：严格被动，自动切换 *************/
    function makePassiveNonSwipeVideoTrial(index, videoFile, yokedDurations) {
      var targetDwell = yokedDurations[index]; // ms

      return {
        type: 'html-keyboard-response',
        stimulus: `
        <div class="video-container">
          <video id="video-${index}" src="${videoFile}" playsinline></video>
        </div>
      `,
        choices: jsPsych.NO_KEYS,  // 按键不会结束 trial
        on_load: function () {
          var v = document.getElementById('video-' + index);
          v.muted = false;
          v.volume = 1.0;

          let realStart = null;

          v.onplaying = function () {
            realStart = performance.now();
          };

          var p = v.play();
          if (p !== undefined) {
            p.catch(function (err) {
              console.log(videoFile + ' play() 被拦截：', err);
            });
          }

          // 到 yoke 时间点自动结束
          autoTimeout = setTimeout(function () {
            var dwell = performance.now() - realStart;
            jsPsych.finishTrial({
              condition: 'passive_non_swipe',
              trace_id: TRACE_ID,
              video_index: index,
              video_file: videoFile,
              target_dwell_ms: targetDwell,
              ended_by: 'auto',
              dwell_ms: dwell
            });
          }, targetDwell);

        }
      };
    }

    /************* Measures 1：Post-viewing self-report & checks *************/
    var post_view_likert_trial = {
      type: 'survey-likert',
      preamble: `
    <div style="padding:10px 5px 0 5px;">
      <p style="font-size:18px; text-align:left;">
        You have finished watching the video feed.<br><br>
        Please answer the following questions about your experience.
      </p>
    </div>
  `,
      questions: [
        {
          prompt: "I felt that I was in control of when the next video appeared.",
          name: "agency_control",
          labels: LIKERT_5,
          required: true
        },
        {
          prompt: "It felt like the system decided when to move to the next video, not me.",
          name: "agency_system",
          labels: LIKERT_5,
          required: true
        },
        {
          prompt: "I felt I was continuing out of habit rather than deliberate choice.",
          name: "habit_vs_deliberate",
          labels: LIKERT_5,
          required: true
        },
        {
          prompt: "If the task had not ended, I would probably have kept going for quite a while.",
          name: "continue_watching",
          labels: LIKERT_5,
          required: true
        },
        {
          prompt: "I found the videos interesting to watch.",
          name: "interest",
          labels: LIKERT_5,
          required: true
        },
        {
          prompt: "I found the videos boring.",
          name: "boredom",
          labels: LIKERT_5,
          required: true
        },
        {
          prompt: `
            <div style="text-align:left;">
              <p>Please indicate how you felt overall while watching the videos (valence).</p>
              <img src="sam_valence.png" style="max-width:100%;height:auto;">
            </div>
          `,
          name: "sam_valence",
          labels: ["1", "2", "3", "4", "5", "6", "7", "8", "9"],
          required: true
        },
        {
          prompt: `
            <div style="text-align:left;">
              <p>Please indicate how aroused or stimulated you felt overall.</p>
              <img src="sam_arousal.png" style="max-width:100%;height:auto;">
            </div>
          `,
          name: "sam_arousal",
          labels: ["1", "2", "3", "4", "5", "6", "7", "8", "9"],
          required: true
        },
        {
          // attention check：用 1–5
          prompt: "To show that you are paying attention, please select ‘4’ for this item.",
          name: "attention_check_1to5",
          labels: [
            "1",
            "2",
            "3",
            "4",
            "5"
          ],
          required: true
        }
      ],
      randomize_question_order: false
    };


    /************* Measures 2：Recognition memory（示例：一页 4 张图） *************/
    var RECOG_ITEMS = [
      { id: "rec1", file: "rec_real_01.png", status: "real" },
      { id: "rec2", file: "rec_real_02.png", status: "real" },
      { id: "rec3", file: "rec_real_03.png", status: "real" },
      { id: "rec4", file: "rec_real_04.png", status: "real" }
    ];

    // 构建 HTML：4 张图 + checkbox
    function buildRecognitionHTML() {
      var html = `
        <div style="width:100vw;height:100vh;display:flex;flex-direction:column;justify-content:flex-start;align-items:center;color:white;padding:10px;box-sizing:border-box;">
          <p style="font-size:18px;text-align:left;width:100%;max-width:500px;margin-bottom:10px;">
            On this page you will see four still images taken from short videos.<br>
            Please tick the videos that you remember seeing in the feed.
          </p>
        <div style="display:flex;flex-wrap:wrap;justify-content:center;gap:10px;width:100%;max-width:500px;">
      `;

      RECOG_ITEMS.forEach(function (item) {
        html += `
        <div style="width:48%;display:flex;flex-direction:column;align-items:center;margin-bottom:10px;">
          <img src="${item.file}" style="width:100%;height:auto;border:1px solid #666;margin-bottom:5px;" />
          <label style="font-size:14px;">
            <input type="checkbox" id="${item.id}" style="margin-right:5px;">
            I saw this video
          </label>
        </div>
      `;
      });

      html += `
      </div>
        <button id="rec-next-btn"
            style="margin-top:15px;padding:10px 20px;font-size:16px;border-radius:8px;border:none;background:#444;color:#fff;">
          Continue
        </button>
      </div>
    `;
      return html;
    }

    var recognition_trial = {
      type: 'html-keyboard-response',
      stimulus: buildRecognitionHTML,
      choices: jsPsych.NO_KEYS,
      on_load: function () {
        var btn = document.getElementById('rec-next-btn');
        btn.addEventListener('click', function () {
          // 读取每个 checkbox 是否勾选
          var selections = {};
          RECOG_ITEMS.forEach(function (item) {
            var checked = document.getElementById(item.id).checked;
            selections[item.id] = {
              checked: checked,
              file: item.file,
              status: item.status
            };
          });
          jsPsych.finishTrial({
            recognition_responses: selections
          });
        });
      }
    };

    /************* Measures 3：Delay Discounting（简版示例） *************/

    // TODO: 在正式版本中，把 items 扩展到 27 个，并用 Kirby 的标准金额和延迟
    var DD_ITEMS = [
      {
        name: "dd1",
        prompt: "1. Would you prefer £54 today or £55 in 117 days?",
        options: ["£54 today", "£55 in 117 days"]
      },
      {
        name: "dd2",
        prompt: "2. Would you prefer £55 today or £75 in 61 days?",
        options: ["£55 today", "£75 in 61 days"]
      },
      {
        name: "dd3",
        prompt: "3. Would you prefer £19 today, or £25 in 53 days?",
        options: ["£19 today", "£25 in 53 days"]
      },
      {
        name: "dd4",
        prompt: "4. Would you prefer £31 today, or £85 in 7 days?",
        options: ["£31 today", "£85 in 7 days?"]
      },
      {
        name: "dd5",
        prompt: "5. Would you prefer £14 today, or £25 in 19 days?",
        options: ["£14 today", "£25 in 19 days"]
      },
      {
        name: "dd6",
        prompt: "6. Would you prefer £47 today, or £50 in 160 days?",
        options: ["£47 today", "£50 in 160 days"]
      },
      {
        name: "dd7",
        prompt: "7. Would you prefer £15 today, or £35 in 13 days?",
        options: ["£15 today", "£35 in 1 month"]
      },
      {
        name: "dd8",
        prompt: "8. Would you prefer £25 today, or £60 in 14 days?",
        options: ["£25 today", "£60 in 4 months"]
      },
      {
        name: "dd9",
        prompt: "9. Would you prefer £78 today, or £80 in 162 days?",
        options: ["£78 today", "£80 in 162 days"]
      },
      {
        name: "dd10",
        prompt: "10. Would you prefer £40 today, or £55 in 62 days?",
        options: ["£40 today", "£55 in 62 days"]
      },
      {
        name: "dd11",
        prompt: "11. Would you prefer £11 today, or £30 in 7 days?",
        options: ["£11 today", "£30 in 7 days"]
      },
      {
        name: "dd12",
        prompt: "12. Would you prefer £67 today, or £75 in 119 days?",
        options: ["£67 today", "£75 in 119 days"]
      },
      {
        name: "dd13",
        prompt: "13. Would you prefer £34 today, or £35 in 186 days?",
        options: ["£34 today", "£35 in 186 days"]
      },
      {
        name: "dd14",
        prompt: "14. Would you prefer £27 today, or £50 in 21 days?",
        options: ["£27 today", "£50 in 21 days"]
      },
      {
        name: "dd15",
        prompt: "15. Would you prefer £69 today, or £85 in 91 days?",
        options: ["£69 today", "£85 in 91 days"]
      },
      {
        name: "dd16",
        prompt: "16. Would you prefer £49 today, or £60 in 89 days?",
        options: ["£49 today", "£60 in 89 days"]
      },
      {
        name: "dd17",
        prompt: "17. Would you prefer £80 today, or £85 in 157 days?",
        options: ["£80 today", "£85 in 157 days"]
      },
      {
        name: "dd18",
        prompt: "18. Would you prefer £24 today, or £35 in 29 days?",
        options: ["£24 today", "£35 in 29 days"]
      },
      {
        name: "dd19",
        prompt: "19. Would you prefer £33 today, or £80 in 14 days?",
        options: ["£33 today", "£80 in 14 days"]
      },
      {
        name: "dd20",
        prompt: "20. Would you prefer £28 today, or £30 in 179 days?",
        options: ["£28 today", "£30 in 179 days"]
      },
      {
        name: "dd21",
        prompt: "21. Would you prefer £34 today, or £50 in 30 days?",
        options: ["£34 today", "£50 in 30 days"]
      },
      {
        name: "dd22",
        prompt: "22. Would you prefer £25 today, or £30 in 80 days?",
        options: ["£25 today", "£30 in 80 days"]
      },
      {
        name: "dd23",
        prompt: "23. Would you prefer £41 today, or £75 in 20 days?",
        options: ["£41 today", "£75 in 20 days"]
      },
      {
        name: "dd24",
        prompt: "24. Would you prefer £54 today, or £60 in 111 days?",
        options: ["£54 today", "£60 in 111 days"]
      },
      {
        name: "dd25",
        prompt: "25. Would you prefer £54 today, or £80 in 30 days?",
        options: ["£54 today", "£80 in 30 days"]
      },
      {
        name: "dd26",
        prompt: "26. Would you prefer £22 today, or £25 in 136 days?",
        options: ["£22 today", "£25 in 136 days"]
      },
      {
        name: "dd27",
        prompt: "27. Would you prefer £20 today, or £55 in 7 days?",
        options: ["£20 today", "£55 in 7 days"]
      }
    ];

    var delay_discount_trial = {
      type: 'survey-multi-choice',
      preamble: `
        <div style="padding:10px 5px 0 5px;">
          <p style="font-size:18px;text-align:left;">
            In this final part, you will make 27 choices.<br>
            For each of the choices, please indicate which reward you would prefer:<br>
            the smaller reward today, or the larger reward in the specified number of days.<br><br>
            Please answer as if these choices were real.
          </p>
        </div>
      `,
      questions: DD_ITEMS.map(function (item) {
        return {
          prompt: item.prompt,
          name: item.name,
          options: item.options,
          required: true
        };
      }),
      randomize_question_order: false
    };


    /************* 根据 CONDITION 构建 5 个视频 trial *************/
    var timeline = [];

    // 先加入 preload & unlock
    timeline.push(preload_trial);
    timeline.push(unlock_trial);

    // 5 个视频 trial
    var yokedDurations = YOKED_TRACES[TRACE_ID] || [4000, 4000, 4000, 4000, 4000];

    for (var i = 0; i < N_VIDEOS; i++) {
      var file = VIDEO_SEQUENCE[i];

      if (CONDITION === 'active') {
        timeline.push(makeActiveVideoTrial(i, file));
      } else if (CONDITION === 'ps') {
        timeline.push(makePassiveSwipeVideoTrial(i, file, yokedDurations));
      } else if (CONDITION === 'pn') {
        timeline.push(makePassiveNonSwipeVideoTrial(i, file, yokedDurations));
      }
    }

    /************* 在 viewing 之后追加 Measures *************/
    timeline.push(post_view_likert_trial);
    timeline.push(recognition_trial);
    timeline.push(delay_discount_trial);


    /************* 结束页 *************/
    var end_trial = {
      type: 'html-keyboard-response',
      stimulus: `
      <p style="font-size:24px; text-align:center; margin-top:40vh;">
        All tasks have been completed.<br><br>
        Thank you for your participation!<br><br>
        Press any key to finish.
      </p>
    `
    };
    timeline.push(end_trial);

    /************* 启动 jsPsych *************/
    jsPsych.init({
      display_element: 'jspsych-target',
      timeline: timeline,
      on_finish: function () {
        jsPsych.data.get().localSave('csv', 'swipe_5videos_' + CONDITION + '_trace' + TRACE_ID + '.csv');
      }
    });
  </script>

</body>

</html>
